___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Web tag for GoogleTagManager",
  "brand": {
    "id": "github.com_facebookincubator",
    "displayName": "facebookincubator",
    "thumbnail": "data:image/jpeg;base64,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\u003d"
  },
  "description": "A web container template that integrates Meta\u0027s parambuilder library to enhances coverage.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const injectScript = require('injectScript');
const logToConsole = require('logToConsole');
const copyFromWindow = require('copyFromWindow');
const getUrl = require('getUrl');

function processAndCollectAllParams() {
  // Call data.gtmOnSuccess when the tag is finished.
  logToConsole("ParamBuilder script loaded successfully, processing and collecting all params...");

  const clientParamBuilder = copyFromWindow('clientParamBuilder');
  if(!clientParamBuilder) {
    logToConsole("ERROR: clientParamBuilder wasn't loaded correctly.");
    data.gtmOnFailure();
    return;
  }
  const currentPageUrl = getUrl();

  if(typeof clientParamBuilder.processAndCollectAllParams === 'function') {
    clientParamBuilder.processAndCollectAllParams(currentPageUrl);
    logToConsole("processAndCollectAllParams completed successfully.");
    data.gtmOnSuccess();
  }
  else if(typeof clientParamBuilder.processAndCollectParams === 'function') {
    clientParamBuilder.processAndCollectParams(currentPageUrl);
    logToConsole("processAndCollectParams completed successfully.");
    data.gtmOnSuccess();
  }
  else {
    logToConsole("ERROR: Neither processAndCollectAllParams nor processAndCollectParams methods found.");
    data.gtmOnFailure();
  }
}

const url = 'https://capi-automation.s3.us-east-2.amazonaws.com/public/client_js/capiParamBuilder/clientParamBuilder.bundle.js';

injectScript(url, processAndCollectAllParams, data.gtmOnFailure, url);


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://capi-automation.s3.us-east-2.amazonaws.com/public/client_js/capiParamBuilder/clientParamBuilder.bundle.js"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "clientParamBuilder"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Successful execution with processAndCollectAllParams method
  code: |-
    // Arrange
    let processAndCollectAllParamsCalled = 0;
    let processAndCollectParamsCalled = 0;
    mock('injectScript', function(url, successCallback, failureCallback) {
      // Immediately call the success callback
      successCallback();
    });
    // Mock the clientParamBuilder that should be available after script loads
    mock('copyFromWindow', function(key) {
      if (key === 'clientParamBuilder') {
        return {
          processAndCollectAllParams: function() {
            // Simulating all setups were done successfully
            processAndCollectAllParamsCalled++;
            return true;
          },
          processAndCollectParams: function() {
            // Simulate the times the method was called
            processAndCollectParamsCalled++;
            return true;
          }
        };
      }
    });
    // Mock logging
    mock('logToConsole', function() {});
    // Act
    runCode({
      gtmOnSuccess: () => assertApi('gtmOnSuccess').wasCalled(),
      gtmOnFailure: () => assertApi('gtmOnFailure').wasCalled()
    });
    // Assert
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
    assertThat(processAndCollectAllParamsCalled).isEqualTo(1);
    assertThat(processAndCollectParamsCalled).isEqualTo(0);
- name: Successful execution with fallback to processAndCollectParams method
  code: |-
    // Arrange
    let processAndCollectParamsCalled = 0;
    mock('injectScript', function(url, successCallback, failureCallback) {
      // Immediately call the success callback
      successCallback();
    });
    // Mock the clientParamBuilder that should be available after script loads
    mock('copyFromWindow', function(key) {
      if (key === 'clientParamBuilder') {
        return {
          processAndCollectAllParams: "not a function",
          processAndCollectParams: function() {
            // Simulate the times the method was called
            processAndCollectParamsCalled++;
            return true;
          }
        };
      }
    });
    // Mock logging
    mock('logToConsole', function() {});
    // Act
    runCode({
      gtmOnSuccess: () => assertApi('gtmOnSuccess').wasCalled(),
      gtmOnFailure: () => assertApi('gtmOnFailure').wasCalled()
    });
    // Assert
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
    assertThat(processAndCollectParamsCalled).isEqualTo(1);
- name: Failure when clientParamBuilder is not loaded
  code: |-
    // Arrange
    const mockData = {
      gtmOnSuccess: function() {
        mockData.successCalled = true;
      },
      gtmOnFailure: function() {
        mockData.failureCalled = true;
      },
      successCalled: false,
      failureCalled: false
    };

    const log = require('logToConsole');
    const injectScript = require('injectScript');
    const copyFromWindow = require('copyFromWindow');

    // Mock successful script injection
    mock('injectScript', function(url, onSuccess, onFailure) {
      onSuccess();
    });

    // Mock missing clientParamBuilder
    mock('copyFromWindow', function(key) {
      return undefined;
    });

    mock('data', mockData);

    // Act
    runCode(mockData);

    // Assertions
    assertApi('gtmOnSuccess').wasNotCalled();
    assertApi('gtmOnFailure').wasCalled();
- name: Failure when neither method exists on clientParamBuilder
  code: |-
    // Arrange
    const mockData = {
      gtmOnSuccess: function() {
        mockData.successCalled = true;
      },
      gtmOnFailure: function() {
        mockData.failureCalled = true;
      },
      successCalled: false,
      failureCalled: false
    };

    const log = require('logToConsole');
    const injectScript = require('injectScript');
    const copyFromWindow = require('copyFromWindow');

    // Mock successful script injection
    mock('injectScript', function(url, onSuccess, onFailure) {
      onSuccess();
    });

    // Mock clientParamBuilder without required methods
    mock('copyFromWindow', function(key) {
      if (key === 'clientParamBuilder') {
        return {
          someOtherMethod: function() {
            // Mock object without required methods
          }
        };
      }
      return undefined;
    });

    mock('data', mockData);

    // Act
    runCode(mockData);

    // Assert
    assertApi('gtmOnSuccess').wasNotCalled();
    assertApi('gtmOnFailure').wasCalled();
- name: Failure when script injection fails
  code: |-
    // Arrange
    const mockData = {
      gtmOnSuccess: function() {
        mockData.successCalled = true;
      },
      gtmOnFailure: function() {
        mockData.failureCalled = true;
      },
      successCalled: false,
      failureCalled: false
    };

    const log = require('logToConsole');
    const injectScript = require('injectScript');
    const copyFromWindow = require('copyFromWindow');

    // Mock failed script injection
    mock('injectScript', function(url, onSuccess, onFailure) {
      onFailure();
    });

    mock('data', mockData);

    // Act
    runCode(mockData);

    // Assert
    assertApi('gtmOnSuccess').wasNotCalled();
    assertApi('gtmOnFailure').wasCalled();
- name: Verify correct script URL is used
  code: |-
    // Arrange
    const mockData = {
      gtmOnSuccess: function() {},
      gtmOnFailure: function() {}
    };

    const log = require('logToConsole');
    let capturedUrl;

    // Mock injectScript to capture the URL
    mock('injectScript', function(url, onSuccess, onFailure) {
      capturedUrl = url;
      onSuccess();
    });

    // Mock clientParamBuilder
    mock('copyFromWindow', function(key) {
      if (key === 'clientParamBuilder') {
        return {
          processAndCollectAllParams: function() {}
        };
      }
      return undefined;
    });

    mock('data', mockData);

    // Act
    runCode(mockData);

    // Assert
    const expectedUrl = 'https://capi-automation.s3.us-east-2.amazonaws.com/public/client_js/capiParamBuilder/clientParamBuilder.bundle.js';
    assertThat(capturedUrl).isEqualTo(expectedUrl);


___NOTES___

Created on 7/30/2025, 11:24:30 AM
